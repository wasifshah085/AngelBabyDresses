name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'server/**'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild Docker image'
        required: false
        default: 'false'
        type: boolean

env:
  PROJECT_NAME: angel-baby-dresses
  DEPLOY_PATH: /var/www/angel-baby-dresses

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: ./server
        run: npm ci

      - name: Run linting (if configured)
        working-directory: ./server
        run: npm run lint --if-present

      - name: Run tests (if configured)
        working-directory: ./server
        run: npm test --if-present
        env:
          NODE_ENV: test

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          FORCE_REBUILD: ${{ github.event.inputs.force_rebuild || 'false' }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            echo "=== Starting deployment ==="
            cd /var/www/angel-baby-dresses

            # Pull latest changes
            echo "Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master

            # Load environment variables
            if [ -f .env.production ]; then
              export $(cat .env.production | grep -v '^#' | xargs)
            fi

            # Rebuild and restart containers
            echo "Rebuilding containers..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d

            # Wait for health check
            echo "Waiting for services to be healthy..."
            sleep 10

            # Check if backend is running
            if docker compose ps | grep -q "angelbaby_backend.*Up"; then
              echo "Backend is running!"
            else
              echo "ERROR: Backend failed to start"
              docker compose logs backend
              exit 1
            fi

            # Check if MongoDB is running
            if docker compose ps | grep -q "angelbaby_mongodb.*Up"; then
              echo "MongoDB is running!"
            else
              echo "ERROR: MongoDB failed to start"
              docker compose logs mongodb
              exit 1
            fi

            # Cleanup old images
            echo "Cleaning up old Docker images..."
            docker image prune -f

            echo "=== Deployment completed successfully! ==="
          ENDSSH

      - name: Verify Deployment
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          echo "Verifying deployment..."
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/health" || echo "000")
          if [ "$response" = "200" ]; then
            echo "Health check passed!"
          else
            echo "WARNING: Health check returned $response"
          fi

      - name: Notify on Success
        if: success()
        run: |
          echo "Deployment successful!"
          echo "API is live at: ${{ secrets.API_URL }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Deployment failed! Please check the logs."
